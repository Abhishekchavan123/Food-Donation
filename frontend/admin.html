<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Food Donation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Middleware-like check for admin authentication
    (function() {
      // Replace 'admin_token' with your actual key if needed
      var token = localStorage.getItem('access_token');
      if (!token) {
        window.location.replace('auth/admin-login.html');
      }
    })();
  </script>
  <!-- Add a modern font and minor global styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --card-bg: #e6eaee;
      --muted: #6b7280;
    }

    /* card background -> neutral gray */
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }

    .fade-up {
      transform: translateY(6px);
      opacity: 0;
      transition: all 300ms ease;
    }

    .fade-up.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* nicer scrollbar for content area */
    #contentMain {
      scrollbar-width: thin;
      scrollbar-color: rgba(100, 116, 139, 0.4) transparent;
    }
  </style>
</head>

<body class="bg-gray-200 h-screen overflow-hidden font-sans"> <!-- page background -> gray-200 -->

  <!-- Navbar -->
  <header
    class="fixed top-0 left-0 w-full h-16 bg-gray-800 text-white flex items-center justify-between px-5 shadow-lg z-20">
    <!-- header -> dark gray -->
    <div class="flex items-center gap-4">
      <button id="drawerToggle" aria-label="Toggle menu" class="p-2 rounded-md bg-white/10 hover:bg-white/20">
        <!-- hamburger -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div class="flex items-baseline gap-3">
        <div class="text-xl font-bold">Food Donation</div>
        <div class="text-xs bg-white/10 px-2 py-0.5 rounded-full">Admin</div>
      </div>
    </div>

    <div class="flex-1 px-6 hidden md:flex items-center justify-center">
      <div class="w-full max-w-2xl">
        <label class="relative block">
          <input id="globalSearch" type="search" aria-label="Search" placeholder="Search contacts, donors, NGOs..."
            class="placeholder:italic placeholder-slate-400 bg-white text-slate-800 w-full border border-slate-200 rounded-full py-2 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-emerald-300" />
          <svg class="pointer-events-none w-5 h-5 absolute left-4 top-2.5 text-slate-400" viewBox="0 0 20 20"
            fill="currentColor">
            <path fill-rule="evenodd"
              d="M12.9 14.32a8 8 0 111.414-1.414l3.387 3.387-1.414 1.414-3.387-3.387zM8 14a6 6 0 100-12 6 6 0 000 12z"
              clip-rule="evenodd" />
          </svg>
        </label>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="refreshBtnTop" title="Refresh" class="p-2 rounded-md bg-white/10 hover:bg-white/20 text-white">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M21 12a9 9 0 11-3-6.7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
      <button id="exportBtnTop" title="Export" class="p-2 rounded-md bg-white/10 hover:bg-white/20 text-white">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-width="2" />
          <path d="M7 10l5-5 5 5" stroke-width="2" />
        </svg>
      </button>

      <!-- profile / login kept -->
      <span id="authLoginLink" class="inline-block">
                  <a href="auth/admin-login.html" class="text-white/90 hover:text-yellow-200 transition">Login / Register</a>
                </span>
                <div id="profileMenuRoot" class="relative z-50 hidden">
                  <button id="profileBtn" type="button" class="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-md text-sm cursor-pointer">
                    <span id="profileAvatar" class="inline-block w-7 h-7 rounded-full bg-yellow-400 text-black font-bold grid place-items-center">U</span>
                    <span id="profileName" class="hidden md:inline">User</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  </button>
                  <div id="profileDropdown" class="absolute right-0 mt-2 w-44 bg-white text-gray-800 rounded-md shadow-lg hidden z-50 pointer-events-auto">
                    
                    <a href="auth/profile.html" id="editProfileLink" class="block px-4 py-2 hover:bg-gray-100 text-sm cursor-pointer">Edit Profile</a>
                    <div class="border-t my-1"></div>
                    <button id="logoutBtn" type="button" class="w-full text-left block px-4 py-2 hover:bg-gray-100 text-sm text-red-600 cursor-pointer">Logout</button>
                  </div>
                </div>
    </div>
  </header>

  <!-- Drawer -->
  <aside id="drawer"
    class="fixed top-16 left-0 w-64 h-[calc(100%-4rem)] bg-gray-100 border-r shadow-sm transform transition-transform duration-300 ease-in-out translate-x-0 flex flex-col py-4 z-10">
    <!-- sidebar -> light gray -->
    <div class="px-4 mb-3">
      <div class="text-lg font-semibold">Admin</div>
      <div class="text-xs text-gray-500">Manage donations & NGOs</div>
    </div>
    <nav class="flex-1 px-2 space-y-1">
      <button class="tab-btn active w-full flex items-center gap-3 px-4 py-2 rounded-lg bg-gray-200 text-gray-900"
        data-tab="contacts"> <!-- active tab -> gray -->
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M21 10a7 7 0 10-14 0" stroke-width="2" />
        </svg>
        <span class="font-medium">Contacts</span>
      </button>
      <button class="tab-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-200"
        data-tab="donations"> <!-- hover -> gray -->
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20 12H4" stroke-width="2" />
        </svg>
        <span class="font-medium">Donations</span>
      </button>
      <button class="tab-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-200" data-tab="ngos">
        <!-- hover -> gray -->
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 2l4 7-4 7-4-7 4-7z" stroke-width="2" />
        </svg>
        <span class="font-medium">NGOs</span>
      </button>
    </nav>
    <div class="px-4 py-3 border-t text-xs text-gray-500">v1.0 • Dashboard</div>
  </aside>

  <!-- Main Content updated -->
  <main id="content" class="pt-20 pl-72 pr-6 pb-6 h-full overflow-y-auto transition-all duration-300 ease-in-out">
    <div id="dashboard" class="space-y-6">
      <!-- stat cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">Contacts</div>
              <div id="contactsCount" class="text-2xl font-bold text-slate-800">—</div>
            </div>
            <div class="bg-emerald-50 rounded-full p-3 text-emerald-600">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 10a7 7 0 10-14 0" stroke-width="2" />
              </svg>
            </div>
          </div>
          <div class="mt-3 text-xs text-slate-500">New messages, inquiries</div>
        </div>

        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">Donations</div>
              <div id="donationsCount" class="text-2xl font-bold text-slate-800">—</div>
            </div>
            <div class="bg-sky-50 rounded-full p-3 text-sky-600">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M20 12H4" stroke-width="2" />
              </svg>
            </div>
          </div>
          <div class="mt-3 text-xs text-slate-500">Active donations and status</div>
        </div>

        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">NGOs</div>
              <div id="ngosCount" class="text-2xl font-bold text-slate-800">—</div>
            </div>
            <div class="bg-indigo-50 rounded-full p-3 text-indigo-600">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2l4 7-4 7-4-7 4-7z" stroke-width="2" />
              </svg>
            </div>
          </div>
          <div class="mt-3 text-xs text-slate-500">Registered organizations</div>
        </div>
      </div>

      <!-- content area -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="col-span-2 card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Overview</h3>
            <div class="text-sm text-slate-500" id="overviewSubtitle">Showing latest</div>
          </div>

          <!-- main table / content target -->
          <div id="contentMain" class="min-h-[240px]">
            <div class="py-12 text-center text-slate-500">Select a tab on the left to view records.</div>
          </div>
        </div>

        <div class="card p-4">
          <h4 class="font-semibold mb-2">Recent Activity</h4>
          <ul id="recentList" class="space-y-3 text-sm text-slate-600">
            <li class="opacity-70">No activity yet.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Replace main UI script: keep backend endpoints and logic but adapt to new DOM -->
  <script>
    const drawer = document.getElementById("drawer");
    const toggleBtn = document.getElementById("drawerToggle");
    const content = document.getElementById("content");
    const buttons = document.querySelectorAll(".tab-btn");
    const globalSearch = document.getElementById("globalSearch");
    const contentMain = document.getElementById("contentMain");
    const contactsCountEl = document.getElementById("contactsCount");
    const donationsCountEl = document.getElementById("donationsCount");
    const ngosCountEl = document.getElementById("ngosCount");
    const recentList = document.getElementById("recentList");
    const viewBadge = document.getElementById("overviewSubtitle");

    // Drawer open/close toggle
    toggleBtn.addEventListener("click", () => {
      const isClosed = drawer.classList.toggle("-translate-x-full");
      if (isClosed) {
        content.classList.remove("pl-72");
        content.classList.add("pl-6");
      } else {
        content.classList.remove("pl-6");
        content.classList.add("pl-72");
      }
    });
    // central state
    window.__adminState = { currentTab: "contacts", data: { contacts: [], donations: [], ngos: [] } };

    function showLoading(target, message = "Loading...") {
      target.innerHTML = `<div class="flex items-center gap-3 py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div><div class="text-slate-600">${message}</div></div>`;
    }
    function showEmptyState(target, msg) {
      target.innerHTML = `<div class="py-10 text-center text-slate-500">${msg}</div>`;
    }

    // initial stats fetch (keeps backend unchanged)
    async function fetchStats() {
      try {
        const [cRes, dRes, nRes] = await Promise.all([
          fetch("http://localhost:4000/api/contact"),
          fetch("http://localhost:4000/api/donations"),
          fetch("http://localhost:4000/api/ngos/register")
        ]);
        const cData = await cRes.json();
        const dData = await dRes.json();
        const nData = await nRes.json();
        window.__adminState.data.contacts = cData.contacts || [];
        window.__adminState.data.donations = dData.donations || [];
        window.__adminState.data.ngos = nData.ngos || [];

        contactsCountEl.textContent = (window.__adminState.data.contacts || []).length;
        donationsCountEl.textContent = (window.__adminState.data.donations || []).length;
        ngosCountEl.textContent = (window.__adminState.data.ngos || []).length;

        // populate recent list (simple top 5 from donations + contacts)
        const recent = []
          .concat((window.__adminState.data.donations || []).slice(-3).map(d => `Donation: ${d.food_type} — ${d.donor_name || d.phone_number}`))
          .concat((window.__adminState.data.contacts || []).slice(-3).map(c => `Contact: ${c.name} — ${c.email}`))
          .slice(0, 5);
        if (recent.length) {
          recentList.innerHTML = recent.map(r => `<li>${r}</li>`).join("");
        } else {
          recentList.innerHTML = '<li class="opacity-70">No recent activity.</li>';
        }
      } catch (err) {
        contactsCountEl.textContent = "-";
        donationsCountEl.textContent = "-";
        ngosCountEl.textContent = "-";
        console.error("Stats fetch failed", err);
      }
    }

    // Tab switching (buttons have data-tab)
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('bg-emerald-50', 'text-emerald-600', 'active'));
        btn.classList.add('bg-emerald-50', 'text-emerald-600', 'active');
        const tab = btn.dataset.tab || btn.textContent.trim().toLowerCase();
        loadTab(tab);
      });
    });

    // keep backend calls same; adapt render target to #contentMain
    async function loadTab(tab) {
      window.__adminState.currentTab = tab;
      viewBadge.textContent = `Showing ${tab}`;
      showLoading(contentMain, `Loading ${tab}...`);
      try {
        if (tab === "contacts") {
          const res = await fetch("http://localhost:4000/api/contact");
          const data = await res.json();
          window.__adminState.data.contacts = data.contacts || [];
          renderContacts(window.__adminState.data.contacts);
        } else if (tab === "donations") {
          const res = await fetch("http://localhost:4000/api/donations");
          const data = await res.json();
          window.__adminState.data.donations = data.donations || [];
          renderDonations(window.__adminState.data.donations);
        } else if (tab === "ngos") {
          const res = await fetch("http://localhost:4000/api/ngos/register");
          const data = await res.json();
          window.__adminState.data.ngos = data.ngos || [];
          renderNGOs(window.__adminState.data.ngos);
        }
        // update counts after loading
        contactsCountEl.textContent = (window.__adminState.data.contacts || []).length;
        donationsCountEl.textContent = (window.__adminState.data.donations || []).length;
        ngosCountEl.textContent = (window.__adminState.data.ngos || []).length;
      } catch (err) {
        contentMain.innerHTML = `<p class='text-red-500'>Error: ${err.message}</p>`;
      }
    }

    // helper
    function escapeHtml(s) { return String(s ?? "").replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

    function renderContacts(contacts) {
      if (!contacts.length) { showEmptyState(contentMain, "No contact messages found."); return; }
      const rows = contacts.map(c => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3">${escapeHtml(c.name)}</td>
          <td class="px-4 py-3">${escapeHtml(c.email)}</td>
          <td class="px-4 py-3">${escapeHtml(c.subject)}</td>
          <td class="px-4 py-3">${escapeHtml(c.message)}</td>
          <td class="px-4 py-3 text-sm text-slate-500">${new Date(c.created_at).toLocaleString()}</td>
        </tr>`).join('');
      contentMain.innerHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-4 py-3 text-left">Name</th>
                <th class="px-4 py-3 text-left">Email</th>
                <th class="px-4 py-3 text-left">Subject</th>
                <th class="px-4 py-3 text-left">Message</th>
                <th class="px-4 py-3 text-left">Date</th>
              </tr>
            </thead>
            <tbody class="divide-y">${rows}</tbody>
          </table>
        </div>`;
    }

    function renderDonations(donations) {
      if (!donations.length) { showEmptyState(contentMain, "No donations found."); return; }
      const rows = donations.map(d => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3">${escapeHtml(d.food_type)}</td>
          <td class="px-4 py-3">${escapeHtml(d.quantity)}</td>
          <td class="px-4 py-3">${escapeHtml(d.expiry_date)}</td>
          <td class="px-4 py-3">${escapeHtml(d.donor_name)}</td>
          <td class="px-4 py-3">${escapeHtml(d.phone_number)}</td>
          <td class="px-4 py-3">${escapeHtml(d.pickup_address)}</td>
          <td class="px-4 py-3">${escapeHtml(d.status)}</td>
        </tr>`).join('');
      contentMain.innerHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-4 py-3 text-left">Food</th>
                <th class="px-4 py-3 text-left">Qty</th>
                <th class="px-4 py-3 text-left">Expiry</th>
                <th class="px-4 py-3 text-left">Donor</th>
                <th class="px-4 py-3 text-left">Phone</th>
                <th class="px-4 py-3 text-left">Pickup</th>
                <th class="px-4 py-3 text-left">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y">${rows}</tbody>
          </table>
        </div>`;
    }

    function renderNGOs(ngos) {
      if (!ngos.length) { showEmptyState(contentMain, "No NGOs found."); return; }
      const rows = ngos.map(n => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 font-medium">${escapeHtml(n.name)}</td>
          <td class="px-4 py-3">${escapeHtml(n.email)}</td>
          <td class="px-4 py-3">${escapeHtml(n.phone)}</td>
          <td class="px-4 py-3">${escapeHtml(n.transport || '-')}</td>
          <td class="px-4 py-3">${escapeHtml(n.areas || '-')}</td>
          <td class="px-4 py-3">${escapeHtml(n.days || '-')}</td>
          <td class="px-4 py-3">${escapeHtml(n.times || '-')}</td>
          <td class="px-4 py-3 text-sm text-slate-500">${new Date(n.created_at).toLocaleString()}</td>
        </tr>`).join('');
      contentMain.innerHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-4 py-3 text-left">Name</th>
                <th class="px-4 py-3 text-left">Email</th>
                <th class="px-4 py-3 text-left">Phone</th>
                <th class="px-4 py-3 text-left">Transport</th>
                <th class="px-4 py-3 text-left">Areas</th>
                <th class="px-4 py-3 text-left">Days</th>
                <th class="px-4 py-3 text-left">Times</th>
                <th class="px-4 py-3 text-left">Registered On</th>
              </tr>
            </thead>
            <tbody class="divide-y">${rows}</tbody>
          </table>
        </div>`;
    }

    // Debounce helper
    function debounce(fn, wait = 250) {
      let t;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // Improved search handler:
    // - if data for current tab is empty, fetch it first (non-invasive)
    // - then filter locally and render
    const performSearch = async () => {
      const q = (globalSearch?.value || '').trim().toLowerCase();
      const tab = window.__adminState.currentTab || 'contacts';

      // If user cleared search, reload the tab's full data
      if (!q) { loadTab(tab); return; }

      // Ensure data for current tab is present; fetch if missing
      const base = window.__adminState.data[tab] || [];
      if (!base.length) {
        // fetch only the requested tab's data (keeps backend unchanged)
        try {
          if (tab === 'contacts') {
            const res = await fetch("http://localhost:4000/api/contact");
            const data = await res.json();
            window.__adminState.data.contacts = data.contacts || [];
          } else if (tab === 'donations') {
            const res = await fetch("http://localhost:4000/api/donations");
            const data = await res.json();
            window.__adminState.data.donations = data.donations || [];
          } else if (tab === 'ngos') {
            const res = await fetch("http://localhost:4000/api/ngos/register");
            const data = await res.json();
            window.__adminState.data.ngos = data.ngos || [];
          }
        } catch (err) {
          console.error('Search fetch failed', err);
          return;
        }
      }

      // Now filter locally and render
      const items = window.__adminState.data[tab] || [];
      const filtered = items.filter(item => Object.values(item || {}).join(' ').toLowerCase().includes(q));
      if (tab === 'contacts') renderContacts(filtered);
      if (tab === 'donations') renderDonations(filtered);
      if (tab === 'ngos') renderNGOs(filtered);
    };

    // Attach debounced listener
    globalSearch?.addEventListener('input', debounce(performSearch, 250));

    // Export and refresh buttons (reuse original endpoints/logic)
    document.getElementById('exportBtnTop')?.addEventListener('click', () => {
      const tab = window.__adminState.currentTab;
      const rows = window.__adminState.data[tab] || [];
      if (!rows.length) { alert('No data to export'); return; }
      const keys = Object.keys(rows[0]);
      const csv = [keys.join(',')].concat(rows.map(r => keys.map(k => `"${String((r[k] ?? '')).replace(/"/g, '""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${tab}_${new Date().toISOString().slice(0, 10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('refreshBtnTop')?.addEventListener('click', async () => {
      await fetchStats();
      loadTab(window.__adminState.currentTab);
    });

    // Initial load
    fetchStats().then(() => { loadTab('contacts'); });

  </script>

  <script>
    (function setupNavProfile() {
      const loginSpan = document.getElementById('authLoginLink');
      const root = document.getElementById('profileMenuRoot');
      const btn = document.getElementById('profileBtn');
      const menu = document.getElementById('profileDropdown');
      const avatar = document.getElementById('profileAvatar');
      const nameEl = document.getElementById('profileName');
      const logoutBtn = document.getElementById('logoutBtn');
      const editProfileLink = document.getElementById('editProfileLink');

      if (!loginSpan || !root) return;
      const token = localStorage.getItem('access_token');
      if (token) {
        let displayName = 'User';
        try {
          const raw = localStorage.getItem('de_authUser');
          if (raw) {
            const u = JSON.parse(raw);
            displayName = (u.fullName || u.email || 'User');
          }
        } catch (_) { }
        if (avatar) avatar.textContent = displayName.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = displayName;
        loginSpan.classList.add('hidden');
        root.classList.remove('hidden');
      } else {
        root.classList.add('hidden');
        loginSpan.classList.remove('hidden');
        return;
      }

      function positionMenu() {
        if (!btn || !menu) return;
        // Temporarily show to measure
        const wasHidden = menu.classList.contains('hidden');
        if (wasHidden) { menu.classList.remove('hidden'); menu.style.visibility = 'hidden'; }
        const rect = btn.getBoundingClientRect();
        menu.style.position = 'fixed';
        menu.style.top = (rect.bottom + 6) + 'px';
        // Align right edges
        const menuWidth = menu.offsetWidth || 176; // ~w-44
        menu.style.left = Math.max(8, rect.right - menuWidth) + 'px';
        menu.style.zIndex = 9999;
        if (wasHidden) { menu.classList.add('hidden'); menu.style.visibility = ''; }
      }
      function openMenu() { positionMenu(); menu.classList.remove('hidden'); }
      function closeMenu() { menu.classList.add('hidden'); }
      function toggleMenu() { if (menu.classList.contains('hidden')) openMenu(); else closeMenu(); }
      if (btn) btn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });
      if (menu) menu.addEventListener('click', (e) => { e.stopPropagation(); });
      document.addEventListener('click', (e) => { if (!root.contains(e.target)) closeMenu(); });
      if (logoutBtn) logoutBtn.addEventListener('click', ()=>{
      try { localStorage.removeItem('access_token'); } catch(_) {}
      try { localStorage.removeItem('de_authUser'); } catch(_) {}
      closeMenu();
      window.location.replace('auth/admin-login.html');
    });
      if (editProfileLink) editProfileLink.addEventListener('click', (e) => {
        e.preventDefault();
        closeMenu();
        window.location.href = 'auth/profile.html';
      });
    })();
  </script>
</body>

</html>